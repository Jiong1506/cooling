<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Materi - Mobile Friendly</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4b6cb7;
            --secondary: #182848;
            --light: #f5f7fa;
            --dark: #333;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            font-size: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        h1 {
            margin: 0;
            font-size: 2em;
        }

        .action-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background-color: var(--secondary);
        }

        #materi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.2s ease;
            display: flex;
            flex-direction: column;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }

        .card-img-container {
            width: 100%;
            height: 200px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        .card-content {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .card-content h3 {
            margin-top: 0;
            font-size: 1.2em;
        }

        .card-content p {
            font-size: 0.9em;
            color: #666;
            flex-grow: 1;
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .card-footer .date {
            font-size: 0.8em;
            color: #888;
        }

        .card-footer .actions i {
            margin-left: 10px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .card-footer .actions .fa-edit { color: var(--info); }
        .card-footer .actions .fa-trash-alt { color: var(--danger); }
        .card-footer .actions .fa-edit:hover { color: #0d8b9d; }
        .card-footer .actions .fa-trash-alt:hover { color: #c82333; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--primary);
        }

        .modal-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .modal-form input,
        .modal-form textarea,
        .modal-form .file-input-wrapper {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 1em;
        }
        
        .modal-form .file-input-wrapper {
            display: flex;
            align-items: center;
            border: 2px dashed #ccc;
            background-color: #f9f9f9;
        }

        .modal-form .file-input-wrapper input[type="file"] {
            display: none;
        }

        .modal-form .file-input-wrapper .file-btn {
            background-color: var(--info);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .modal-form .file-input-wrapper .file-btn:hover {
            background-color: #0d8b9d;
        }

        .modal-form .file-input-wrapper .file-name {
            margin-left: 10px;
            color: #555;
            font-style: italic;
        }
        
        #image-preview {
            display: none;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
            text-align: center;
            position: relative;
        }
        
        #image-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            padding-top: 50px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            overflow: auto;
        }

        .image-modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
        }

        .image-modal-content img {
            width: 100%;
            height: auto;
            object-fit: contain;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #bbb;
            text-decoration: none;
        }
        
        .message-box {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            text-align: center;
        }

        .message-box .message-content {
            margin-bottom: 20px;
        }

        .message-box .message-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Sistem Manajemen Materi Safety</h1>
            <p>Kelola materi pembelajaran keselamatan Anda dengan mudah.</p>
        </header>

        <div class="action-bar">
            <button class="btn" id="tambahMateriBtn">
                <i class="fas fa-plus"></i> Tambah Materi
            </button>
        </div>

        <div id="materi-grid">
            <!-- Materi akan di-render di sini -->
        </div>
    </div>

    <!-- Modal untuk menambah/mengedit materi -->
    <div id="materiModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="modalTitle">Tambah Materi Baru</h2>
            <form id="materiForm" class="modal-form">
                <input type="hidden" id="materiId">
                <label for="judul">Judul:</label>
                <input type="text" id="judul" required>
                
                <label for="deskripsi">Deskripsi:</label>
                <textarea id="deskripsi" rows="4" required></textarea>
                
                <label for="file">Gambar:</label>
                <div class="file-input-wrapper">
                    <input type="file" id="file" accept="image/*">
                    <label for="file" class="file-btn">Pilih File</label>
                    <span id="fileName" class="file-name">Belum ada file dipilih</span>
                </div>

                <div id="image-preview">
                    <img id="previewImage" src="" alt="Image Preview">
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn"><i class="fas fa-save"></i> Simpan</button>
                    <button type="button" class="btn" id="cancelBtn"><i class="fas fa-times"></i> Batal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal untuk menampilkan gambar dalam ukuran besar -->
    <div id="imageModal" class="image-modal">
        <span class="close-btn">&times;</span>
        <img class="image-modal-content" id="expandedImg">
    </div>

    <!-- Kotak Pesan Kustom (Menggantikan alert/confirm) -->
    <div id="messageBox" class="message-box">
        <div id="messageContent" class="message-content"></div>
        <div id="messageActions" class="message-actions"></div>
    </div>

    <!-- Library Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Pastikan Anda mengganti ini dengan URL dan kunci anon dari proyek Supabase Anda
        const SUPABASE_URL = 'https://fmojopylouptyrrdrdrrdrd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtb2pvcHlsb3VwdHlycmRydHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE2NTk0MjU0MzcsImV4cCI6MTk3NDk1MTQzN30.I22aA6S0G-m2-yD0A3_r_5J8fA3xI0r9O_8c4Z5o9jI';

        // Inisialisasi Supabase
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Elemen DOM
        const tambahMateriBtn = document.getElementById('tambahMateriBtn');
        const materiModal = document.getElementById('materiModal');
        const materiForm = document.getElementById('materiForm');
        const materiGrid = document.getElementById('materi-grid');
        const modalTitle = document.getElementById('modalTitle');
        const materiIdInput = document.getElementById('materiId');
        const judulInput = document.getElementById('judul');
        const deskripsiInput = document.getElementById('deskripsi');
        const fileInput = document.getElementById('file');
        const fileNameSpan = document.getElementById('fileName');
        const imagePreviewDiv = document.getElementById('image-preview');
        const previewImage = document.getElementById('previewImage');
        const cancelBtn = document.getElementById('cancelBtn');
        const closeModals = document.querySelectorAll('.close-btn');

        // Elemen Modal Gambar
        const imageModal = document.getElementById('imageModal');
        const expandedImg = document.getElementById('expandedImg');

        // Elemen Kotak Pesan Kustom
        const messageBox = document.getElementById('messageBox');
        const messageContent = document.getElementById('messageContent');
        const messageActions = document.getElementById('messageActions');

        let isEditing = false;
        let selectedFile = null;

        document.addEventListener('DOMContentLoaded', async () => {
            fetchMateriRealtime();
        });

        // =========================================================
        // FUNGSI UTAMA
        // =========================================================

        /**
         * Mengambil data materi secara real-time dari Supabase.
         * Menggunakan `on` untuk mendengarkan perubahan data (insert, update, delete).
         */
        function fetchMateriRealtime() {
            // Gunakan metode `from` dengan nama tabel yang benar
            supabase.from('materi')
                .on('INSERT', (payload) => {
                    renderMateri([payload.new]);
                })
                .on('UPDATE', (payload) => {
                    // Update tampilan materi jika ada perubahan
                    const updatedMateri = payload.new;
                    const card = document.getElementById(`materi-card-${updatedMateri.id}`);
                    if (card) {
                        const img = card.querySelector('.card-img');
                        const h3 = card.querySelector('.card-content h3');
                        const p = card.querySelector('.card-content p');
                        const dateSpan = card.querySelector('.card-footer .date');
                        img.src = updatedMateri.gambar;
                        h3.textContent = updatedMateri.judul;
                        p.textContent = updatedMateri.deskripsi;
                        dateSpan.textContent = formatTanggal(updatedMateri.tanggal);
                    }
                })
                .on('DELETE', (payload) => {
                    // Hapus kartu materi dari tampilan
                    const card = document.getElementById(`materi-card-${payload.old.id}`);
                    if (card) {
                        card.remove();
                    }
                })
                .subscribe(); // Jangan lupa untuk subscribe!
            
            // Lakukan pengambilan data awal
            fetchInitialMateri();
        }

        /**
         * Mengambil data awal dari tabel materi.
         */
        async function fetchInitialMateri() {
            const { data, error } = await supabase
                .from('materi')
                .select('*');

            if (error) {
                console.error('Error fetching initial materi:', error);
                showMessageBox('Gagal memuat materi. Silakan coba lagi.', 'error');
                return;
            }

            renderMateri(data);
        }
        
        /**
         * Merender materi ke dalam grid.
         * @param {Array} materiData - Data materi yang akan ditampilkan.
         */
        function renderMateri(materiData) {
            materiData.forEach(materi => {
                const existingCard = document.getElementById(`materi-card-${materi.id}`);
                if (existingCard) return; // Hindari duplikasi saat real-time update

                const card = document.createElement('div');
                card.className = 'card';
                card.id = `materi-card-${materi.id}`;
                
                const imageUrl = materi.gambar || 'https://placehold.co/600x400/CCCCCC/333333?text=Tidak+Ada+Gambar';

                card.innerHTML = `
                    <div class="card-img-container">
                        <img src="${imageUrl}" alt="${materi.judul}" class="card-img" onclick="window.showImage('${imageUrl}')">
                    </div>
                    <div class="card-content">
                        <h3>${escapeHtml(materi.judul)}</h3>
                        <p>${escapeHtml(materi.deskripsi)}</p>
                    </div>
                    <div class="card-footer">
                        <span class="date">${formatTanggal(materi.tanggal)}</span>
                        <div class="actions">
                            <i class="fas fa-edit edit-btn" data-id="${materi.id}"></i>
                            <i class="fas fa-trash-alt delete-btn" data-id="${materi.id}"></i>
                        </div>
                    </div>
                `;
                materiGrid.prepend(card); // Tambahkan di awal agar materi terbaru muncul di atas
            });
        }

        /**
         * Fungsi untuk menambah atau mengedit materi.
         * @param {Event} e - Objek event dari form submit.
         */
        async function tambahMateri(e) {
            e.preventDefault();
            const judul = judulInput.value;
            const deskripsi = deskripsiInput.value;
            const id = materiIdInput.value;

            // Tampilkan pesan loading
            showMessageBox('Sedang memproses...', 'info', false);

            try {
                let imageUrl = previewImage.src; // Ambil URL gambar yang sudah ada

                // Jika ada file baru dipilih, unggah terlebih dahulu
                if (selectedFile) {
                    const fileExt = selectedFile.name.split('.').pop();
                    const fileName = `${Date.now()}.${fileExt}`;
                    const filePath = `materi-images/${fileName}`;

                    // Unggah file ke Supabase Storage
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('materi-images') // Pastikan nama bucket sama
                        .upload(filePath, selectedFile, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (uploadError) {
                        throw uploadError;
                    }
                    
                    // Ambil URL publik dari file yang diunggah
                    const { data: publicUrlData } = supabase.storage
                        .from('materi-images')
                        .getPublicUrl(filePath);

                    imageUrl = publicUrlData.publicUrl;
                }

                if (isEditing) {
                    // Update materi
                    const { error } = await supabase
                        .from('materi')
                        .update({ judul, deskripsi, gambar: imageUrl })
                        .eq('id', id);

                    if (error) throw error;

                    showMessageBox('Materi berhasil diperbarui!', 'success');
                } else {
                    // Tambah materi baru
                    const { error } = await supabase
                        .from('materi')
                        .insert([{ judul, deskripsi, gambar: imageUrl }]);
                    
                    if (error) throw error;

                    showMessageBox('Materi berhasil ditambahkan!', 'success');
                }
                
                // Tutup modal setelah berhasil
                materiModal.style.display = 'none';
                materiForm.reset();
                resetForm();

            } catch (error) {
                console.error('Error:', error);
                showMessageBox(`Gagal ${isEditing ? 'memperbarui' : 'menambah'} materi: ${error.message}`, 'error');
            }
        }
        
        /**
         * Fungsi untuk menghapus materi.
         * @param {string} id - ID materi yang akan dihapus.
         */
        async function hapusMateri(id) {
            showMessageBox('Apakah Anda yakin ingin menghapus materi ini?', 'confirm', true, async () => {
                // Tampilkan loading saat proses
                showMessageBox('Sedang menghapus...', 'info', false);
                try {
                    const { data, error } = await supabase
                        .from('materi')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    
                    showMessageBox('Materi berhasil dihapus!', 'success');
                } catch (error) {
                    console.error('Error removing document:', error);
                    showMessageBox('Gagal menghapus materi. Silakan coba lagi.', 'error');
                }
            });
        }


        // =========================================================
        // EVENT LISTENERS DAN FUNGSI UI
        // =========================================================

        tambahMateriBtn.addEventListener('click', () => {
            isEditing = false;
            modalTitle.textContent = 'Tambah Materi Baru';
            materiForm.reset();
            resetForm();
            materiModal.style.display = 'flex';
        });

        // Delegasi event untuk tombol edit dan hapus
        materiGrid.addEventListener('click', async (e) => {
            if (e.target.classList.contains('edit-btn')) {
                const id = e.target.getAttribute('data-id');
                const { data, error } = await supabase
                    .from('materi')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) {
                    console.error('Error fetching materi for edit:', error);
                    showMessageBox('Gagal mengambil data materi. Silakan coba lagi.', 'error');
                    return;
                }

                isEditing = true;
                modalTitle.textContent = 'Edit Materi';
                materiIdInput.value = data.id;
                judulInput.value = data.judul;
                deskripsiInput.value = data.deskripsi;
                
                // Tampilkan gambar pratinjau jika ada
                if (data.gambar) {
                    previewImage.src = data.gambar;
                    imagePreviewDiv.style.display = 'block';
                    fileNameSpan.textContent = data.gambar.split('/').pop();
                } else {
                    imagePreviewDiv.style.display = 'none';
                    fileNameSpan.textContent = 'Belum ada file dipilih';
                }

                materiModal.style.display = 'flex';
            }

            if (e.target.classList.contains('delete-btn')) {
                const id = e.target.getAttribute('data-id');
                hapusMateri(id);
            }
        });

        // Logika untuk menampilkan file yang dipilih
        fileInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                fileNameSpan.textContent = selectedFile.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    imagePreviewDiv.style.display = 'block';
                };
                reader.readAsDataURL(selectedFile);
            } else {
                fileNameSpan.textContent = 'Belum ada file dipilih';
                imagePreviewDiv.style.display = 'none';
            }
        });
        
        // Menutup modal
        closeModals.forEach(btn => {
            btn.addEventListener('click', () => {
                materiModal.style.display = 'none';
                imageModal.style.display = 'none';
            });
        });

        cancelBtn.addEventListener('click', () => {
            materiModal.style.display = 'none';
        });

        materiForm.addEventListener('submit', tambahMateri);

        // Menutup modal saat klik di luar
        window.addEventListener('click', (e) => {
            if (e.target === materiModal) {
                materiModal.style.display = 'none';
            }
            if (e.target === imageModal) {
                imageModal.style.display = 'none';
            }
            if (e.target === messageBox) {
                 messageBox.style.display = 'none';
            }
        });

        // Fungsi untuk menampilkan gambar dalam modal besar
        window.showImage = function(src) {
            expandedImg.src = src;
            imageModal.style.display = 'block';
        };

        // =========================================================
        // UTILITAS
        // =========================================================
        
        /**
         * Menampilkan kotak pesan kustom (menggantikan alert/confirm).
         * @param {string} message - Pesan yang akan ditampilkan.
         * @param {string} type - 'success', 'error', 'info', atau 'confirm'.
         * @param {boolean} showConfirmButtons - Tampilkan tombol OK/Cancel.
         * @param {function} onConfirm - Callback saat tombol OK diklik.
         */
        function showMessageBox(message, type, showConfirmButtons = false, onConfirm = null) {
            messageContent.textContent = message;
            messageActions.innerHTML = '';
            
            if (showConfirmButtons) {
                const okBtn = document.createElement('button');
                okBtn.className = 'btn';
                okBtn.textContent = 'OK';
                okBtn.onclick = () => {
                    if (onConfirm) onConfirm();
                    messageBox.style.display = 'none';
                };

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn';
                cancelBtn.textContent = 'Batal';
                cancelBtn.onclick = () => {
                    messageBox.style.display = 'none';
                };

                messageActions.appendChild(okBtn);
                messageActions.appendChild(cancelBtn);

            } else {
                const closeBtn = document.createElement('button');
                closeBtn.className = 'btn';
                closeBtn.textContent = 'Tutup';
                closeBtn.onclick = () => {
                    messageBox.style.display = 'none';
                };
                messageActions.appendChild(closeBtn);
            }

            messageBox.style.display = 'block';
        }

        /**
         * Mengembalikan form ke keadaan semula.
         */
        function resetForm() {
            selectedFile = null;
            materiIdInput.value = '';
            fileNameSpan.textContent = 'Belum ada file dipilih';
            imagePreviewDiv.style.display = 'none';
            materiModal.style.display = 'none';
        }

        /**
         * Memformat tanggal ke format lokal.
         * @param {string} dateString - String tanggal dari Supabase.
         * @returns {string} - Tanggal yang diformat.
         */
        function formatTanggal(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        /**
         * Mengubah karakter khusus menjadi entitas HTML untuk mencegah XSS.
         * @param {string} str - String yang akan di-escape.
         * @returns {string} - String yang sudah di-escape.
         */
        function escapeHtml(str) {
            if (!str) return '';
            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

    </script>
</body>
</html>
